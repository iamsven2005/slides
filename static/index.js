const $=(e,t=document)=>t.querySelector(e),$$=(e,t=document)=>Array.from(t.querySelectorAll(e)),uuidv4=()=>"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)),debounce=(e,t=400)=>{let n;return(...i)=>{clearTimeout(n),n=setTimeout(()=>e(...i),t)}},deckId=new URL(location.href).searchParams.get("deck");$("#url").textContent=location.href;let deck={id:deckId,title:"Untitled deck",slides:[]},currentIndex=0,isApplyingRemote=!1,serverVersion=0,selection=[],dragState=null,creatingObj=null,marquee=null,lastMouse={x:200,y:150},history=[],historyIndex=-1;const MAX_HISTORY=100,clone=e=>JSON.parse(JSON.stringify(e));function pushHistory(){if(isApplyingRemote)return;let e=clone(deck),t=history[historyIndex];t&&JSON.stringify(t)===JSON.stringify(e)||((history=history.slice(0,historyIndex+1)).push(e),history.length>100&&history.shift(),historyIndex=history.length-1,updateUndoRedoUI())}function applyState(e){deck=clone(e),selection=[],renderAll(),postSave(),updateUndoRedoUI()}function undo(){historyIndex>0&&applyState(history[--historyIndex])}function redo(){historyIndex<history.length-1&&applyState(history[++historyIndex])}function updateUndoRedoUI(){let e=$("#undoBtn"),t=$("#redoBtn");e&&t&&(e.disabled=historyIndex<=0,t.disabled=historyIndex>=history.length-1)}let appClipboard=null,lastPasteBump=0;const PASTE_BUMP_STEP=16,deepClone=e=>JSON.parse(JSON.stringify(e)),clamp=(e,t,n)=>Math.min(n,Math.max(t,e));function getSelectedObjects(){return currentSlide().objects.filter(e=>selection.includes(e.id))}function asClipboardPayload(e){return{type:"realtime-slides",version:1,objects:deepClone(e)}}function duplicateSlideAt(e){Array.isArray(deck.slides)||(deck.slides=[]);let t=deck.slides[e];if(!t)return;let n=deepClone(t);n.id=uuidv4(),n.title=(t.title||`Slide ${e+1}`)+" (copy)",Array.isArray(n.objects)||(n.objects=[]),n.objects.forEach(e=>{e.id=uuidv4()}),deck.slides.splice(e+1,0,n),currentIndex=e+1,renderAll(),pushHistory(),saveNow()}function copySelected(){let e=getSelectedObjects();if(!e.length)return;let t=asClipboardPayload(e);appClipboard=t,navigator.clipboard?.writeText&&navigator.clipboard.writeText(JSON.stringify(t)).catch(()=>{})}function cutSelected(){let e=currentSlide(),t=getSelectedObjects();t.length&&(copySelected(),e.objects=e.objects.filter(e=>!selection.includes(e.id)),selection=[],renderCanvas(),pushHistory(),postSave())}function pasteObjectsAt(e,t,n){let i=currentSlide(),l=Math.min(...e.map(e=>e.x)),s=Math.min(...e.map(e=>e.y));t=(t??200)+(lastPasteBump=(lastPasteBump+16)%80),n=(n??150)+lastPasteBump;let r=[];e.forEach(e=>{let a=deepClone(e);a.id=uuidv4();let d=e.x-l,o=e.y-s;a.x=clamp(Math.round(t+d),0,960-Math.max(5,e.width)),a.y=clamp(Math.round(n+o),0,540-Math.max(5,e.height)),i.objects.push(a),r.push(a.id)}),selection=r,renderCanvas(),pushHistory(),postSave()}async function pasteFromClipboard(){let e=null;try{if(navigator.clipboard?.readText){let t=await navigator.clipboard.readText();if(t){let n=JSON.parse(t);n?.type==="realtime-slides"&&Array.isArray(n.objects)&&(e=n)}}}catch(i){}!e&&appClipboard&&(e=appClipboard),e&&pasteObjectsAt(e.objects,lastMouse.x,lastMouse.y)}const socket=io();socket.on("connect",()=>{socket.emit("join_deck",{deck_id:deckId})}),socket.off?.("deck_state");let loadedOnce=!1,pendingEchoes=0,isPresenting=!1;function currentSlide(){return deck.slides[currentIndex]}function ensureSlide(){deck.slides.length||deck.slides.push({id:uuidv4(),title:"Slide 1",background:"#ffffff",objects:[]})}function setSaving(){$("#saveState").textContent="Saving…"}function setSaved(e){$("#saveState").textContent=e||"Saved"}socket.on("deck_state",e=>{let t=Number(e.version||0);if(!(t<=serverVersion)){if(serverVersion=t,!loadedOnce){loadedOnce=!0,isApplyingRemote=!0,deck=e,history=[],historyIndex=-1,isApplyingRemote=!1,isPresenting?renderPresentation():renderAll(),setSaved("Loaded v"+serverVersion);return}if(pendingEchoes>0){pendingEchoes--,setSaved("Saved v"+serverVersion);return}isApplyingRemote=!0,deck=e,isApplyingRemote=!1,isPresenting?renderPresentation():renderAll(),setSaved("Synced v"+serverVersion)}});let postSave=debounce(()=>{setSaving(),pendingEchoes++,socket.emit("content_update",{deck_id:deck.id,title:deck.title,slides:deck.slides}),setSaved("Saved")},250);function saveNow(){pendingEchoes++,socket.emit("content_update",{deck_id:deck.id,title:deck.title,slides:deck.slides}),setSaved("Saved")}let tool="select";const toolButtons={select:$("#tool-select"),rect:$("#tool-rect"),ellipse:$("#tool-ellipse"),text:$("#tool-text")};function setTool(e){tool=e,Object.entries(toolButtons).forEach(([e,t])=>t.classList.toggle("active",e===tool))}Object.entries(toolButtons).forEach(([e,t])=>t.onclick=()=>setTool(e)),setTool("select");const bgInput=$("#bg-color"),colorInput=$("#color"),fontInput=$("#fontSize");function setFontSize(e){let t=currentSlide(),n=!1;selection.forEach(i=>{let l=t.objects.find(e=>e.id===i);l&&"text"===l.type&&(l.fontSize=e,n=!0)}),n&&(renderCanvas(),postSave())}function clampInt(e,t,n,i){let l=parseInt(e,10);return Number.isFinite(l)?Math.max(t,Math.min(n,l)):i}function updateInspector(){let e=currentSlide(),t=e.objects.find(e=>selection.includes(e.id));bgInput.value=e.background||"#ffffff";let n=!!(t&&"text"===t.type);colorInput.value=t?"text"===t.type?t.color||"#111111":"image"===t.type?"#111111":t.fill||"#8b5cf6":colorInput.value,fontInput.disabled=!n,n&&(fontInput.value=t.fontSize||24);let i=(e,t)=>{e.disabled=!t,e.style.opacity=t?"1":".5"};i($("#alignLeft"),n),i($("#alignCenter"),n),i($("#alignRight"),n),i($("#boldBtn"),n),i($("#italicBtn"),n),i($("#underlineBtn"),n)}bgInput.addEventListener("input",e=>{currentSlide().background=e.target.value,renderCanvas(),pushHistory(),postSave()}),colorInput.addEventListener("input",e=>{if(!selection.length)return;let t=currentSlide(),n=e.target.value;selection.forEach(e=>{let i=t.objects.find(t=>t.id===e);i&&("text"===i.type?i.color=n:"image"!==i.type&&(i.fill=n))}),renderCanvas(),postSave()}),colorInput.addEventListener("change",()=>{pushHistory()}),fontInput.addEventListener("input",e=>{let t=clampInt(e.target.value,8,200,32);setFontSize(t)}),fontInput.addEventListener("change",e=>{let t=clampInt(e.target.value,8,200,32);setFontSize(t),pushHistory()});const stage=$("#stage");function normRect(e){let t=Math.min(e.x0,e.x1),n=Math.min(e.y0,e.y1);return{x:t,y:n,width:Math.abs(e.x1-e.x0),height:Math.abs(e.y1-e.y0)}}function intersects(e,t){return!(e.x>t.x+t.width||e.x+e.width<t.x||e.y>t.y+t.height||e.y+e.height<t.y)}function selectAllText(e){let t=document.createRange();t.selectNodeContents(e);let n=window.getSelection();n.removeAllRanges(),n.addRange(t)}function bindRichTextAutosave(e,t){let n=()=>{t.html=e.innerHTML,t.text=e.innerText,postSave()};e.addEventListener("input",n),e.addEventListener("keyup",n),e.addEventListener("mouseup",n),e.addEventListener("paste",()=>setTimeout(n,0))}function renderCanvas(){ensureSlide();let e=currentSlide();if(stage.style.background=e.background||"#ffffff",stage.innerHTML="",e.objects.forEach(t=>{let n=document.createElement("div");if(n.id="obj-"+t.id,n.className="obj"+(selection.includes(t.id)?" selected":""),n.style.left=t.x+"px",n.style.top=t.y+"px",n.style.width=t.width+"px",n.style.height=t.height+"px",n.style.transform=`rotate(${t.rotation||0}deg)`,"rect"===t.type)n.style.background=t.fill||"#ddd",n.style.border="1px solid "+(t.stroke||"transparent");else if("ellipse"===t.type)n.style.background=t.fill||"#ddd",n.style.border="1px solid "+(t.stroke||"transparent"),n.style.borderRadius="999px";else if("text"===t.type)n.contentEditable=!0,n.style.color=t.color||"#111111",n.style.fontSize=(t.fontSize||24)+"px",n.style.fontFamily=t.fontFamily||"system-ui, Segoe UI, Roboto, sans-serif",n.style.whiteSpace="pre-wrap",applyTextAlignStyles(n,t.align),n.innerHTML=t.html??(t.text||""),bindRichTextAutosave(n,t),n.addEventListener("dblclick",()=>{n.focus(),selectAllText(n)});else if("image"===t.type){let i=new Image;i.src=t.dataUrl,i.draggable=!1,i.style.width="100%",i.style.height="100%",i.style.objectFit="contain",n.appendChild(i)}if(n.onmousedown=n=>{if("select"!==tool)return;n.stopPropagation(),"text"===t.type&&n.detail<2&&n.preventDefault();let i=selection.includes(t.id);selection=n.shiftKey?i?selection.filter(e=>e!==t.id):[...selection,t.id]:i?selection:[t.id];let l=stage.getBoundingClientRect(),s=n.clientX-l.left,r=n.clientY-l.top,a=selection.slice(),d={};a.forEach(t=>{let n=e.objects.find(e=>e.id===t);d[t]={dx:s-n.x,dy:r-n.y}}),dragState={ids:a,offsets:d},updateInspector(),renderCanvas()},selection.includes(t.id)){let l=document.createElement("div");l.className="handle",l.style.position="absolute",l.style.right="-6px",l.style.bottom="-6px",l.style.width="12px",l.style.height="12px",l.style.cursor="se-resize",l.onmousedown=e=>{e.stopPropagation();let n=stage.getBoundingClientRect(),i=e.clientX-n.left,l=e.clientY-n.top,s=t.width,r=t.height,a=e=>{let a=e.clientX-n.left,d=e.clientY-n.top;t.width=Math.max(5,s+(a-i)),t.height=Math.max(5,r+(d-l)),renderCanvas()},d=()=>{window.removeEventListener("mousemove",a),window.removeEventListener("mouseup",d),pushHistory(),postSave()};window.addEventListener("mousemove",a),window.addEventListener("mouseup",d)},n.appendChild(l)}stage.appendChild(n)}),marquee){let t=normRect(marquee),n=document.createElement("div");n.className="marquee",n.style.left=t.x+"px",n.style.top=t.y+"px",n.style.width=t.width+"px",n.style.height=t.height+"px",stage.appendChild(n)}}function moveItem(e,t,n){if(t===n||t<0||n<0||t>=e.length||n>=e.length)return e;let i=e.splice(t,1)[0];return e.splice(n,0,i),e}function renderSlidesList(){let e=$("#slides");e.innerHTML="",deck.slides.forEach((t,n)=>{let i=document.createElement("div");i.className="slide-item"+(n===currentIndex?" active":""),i.onclick=()=>{currentIndex=n,selection=[],renderAll()},i.dataset.index=String(n),i.draggable=!0,i.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/plain",String(n)),e.dataTransfer.effectAllowed="move"}),i.addEventListener("dragover",e=>{e.preventDefault(),i.classList.add("drag-over")}),i.addEventListener("dragleave",()=>{i.classList.remove("drag-over")}),i.addEventListener("drop",e=>{e.preventDefault(),i.classList.remove("drag-over");let t=parseInt(e.dataTransfer.getData("text/plain"),10),l=n;Number.isFinite(t)&&(moveItem(deck.slides,t,l),currentIndex=l,renderSlidesList(),pushHistory(),postSave())});let l=document.createElement("div");l.className="n",l.textContent=n+1;let s=document.createElement("input");s.value=t.title||`Slide ${n+1}`,s.onmousedown=e=>e.stopPropagation(),s.oninput=()=>{t.title=s.value,pushHistory(),postSave()};let r=document.createElement("button");r.textContent="⎘",r.title="Duplicate",r.className="btn",r.onclick=e=>{e.stopPropagation(),duplicateSlideAt(n)};let a=document.createElement("button");a.textContent="\uD83D\uDDD1",a.title="Delete",a.className="btn",a.onclick=e=>{e.stopPropagation(),1!==deck.slides.length&&(deck.slides.splice(n,1),currentIndex=Math.max(0,Math.min(currentIndex,deck.slides.length-1)),pushHistory(),renderAll(),postSave())},i.appendChild(l),i.appendChild(s),i.appendChild(r),i.appendChild(a),e.appendChild(i)})}function renderAll(){$("#deckTitle").value=deck.title||"Untitled deck",currentIndex>=deck.slides.length&&(currentIndex=deck.slides.length-1),currentIndex<0&&(currentIndex=0),renderSlidesList(),renderCanvas(),updateInspector(),updateUndoRedoUI()}function activelySelectingText(){let e=document.activeElement;if(!e||!e.isContentEditable)return!1;let t=window.getSelection?.();return t&&!t.isCollapsed}function handleImageFile(e,t,n){let i=new FileReader;i.onload=()=>{let e=i.result,l=new Image;l.onload=()=>{let i=l.naturalWidth,s=l.naturalHeight,r=Math.min(1,600/i,400/s);i=Math.max(40,Math.round(i*r)),s=Math.max(40,Math.round(s*r));let a=currentSlide(),d={id:uuidv4(),type:"image",x:Math.max(0,Math.min((t||200)-i/2,960-i)),y:Math.max(0,Math.min((n||150)-s/2,540-s)),width:i,height:s,rotation:0,dataUrl:e};a.objects.push(d),selection=[d.id],renderCanvas(),pushHistory(),postSave()},l.src=e},i.readAsDataURL(e)}stage.addEventListener("mousedown",e=>{if(0!==e.button)return;let t=stage.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;if(lastMouse={x:n,y:i},e.target===stage&&"select"===tool){marquee={x0:n,y0:i,x1:n,y1:i},renderCanvas();return}"select"!==tool&&e.target===stage&&(creatingObj={id:uuidv4(),type:tool,x:n,y:i,width:1,height:1,fill:"text"===tool?"transparent":"#8b5cf6",stroke:"#0f172a",rotation:0,text:"text"===tool?"Text":void 0,html:"text"===tool?"Text":void 0,fontSize:24,fontFamily:"system-ui, Segoe UI, Roboto, sans-serif",color:"#111111"},renderCanvas())}),window.addEventListener("mousemove",e=>{let t=stage.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;if(lastMouse={x:n,y:i},creatingObj&&(creatingObj.width=n-creatingObj.x,creatingObj.height=i-creatingObj.y,renderCanvas()),dragState){let l=currentSlide();dragState.ids.forEach(e=>{let t=l.objects.find(t=>t.id===e),s=dragState.offsets[e];t.x=n-s.dx,t.y=i-s.dy}),renderCanvas()}marquee&&(marquee.x1=n,marquee.y1=i,renderCanvas())}),window.addEventListener("mouseup",()=>{if(creatingObj){let e=currentSlide();creatingObj.width<0&&(creatingObj.x+=creatingObj.width,creatingObj.width=Math.abs(creatingObj.width)),creatingObj.height<0&&(creatingObj.y+=creatingObj.height,creatingObj.height=Math.abs(creatingObj.height)),e.objects.push(creatingObj),selection=[creatingObj.id],renderCanvas(),pushHistory(),postSave(),"text"===creatingObj.type&&setTimeout(()=>{let e=document.getElementById("obj-"+creatingObj.id);e&&(e.focus(),selectAllText(e))},0),creatingObj=null}if(dragState&&(pushHistory(),postSave(),dragState=null),marquee){let t=currentSlide(),n=normRect(marquee);selection=t.objects.filter(e=>intersects(n,{x:e.x,y:e.y,width:e.width,height:e.height})).map(e=>e.id),marquee=null,renderCanvas(),updateInspector()}}),$("#deckTitle").addEventListener("input",e=>{deck.title=e.target.value,pushHistory(),renderSlidesList(),postSave()}),$("#addSlide").addEventListener("click",()=>{let e=deck.slides.length+1;deck.slides.push({id:uuidv4(),title:"Slide "+e,background:"#ffffff",objects:[]}),currentIndex=deck.slides.length-1,pushHistory(),renderAll(),postSave()}),$("#delSlide").addEventListener("click",()=>{1!==deck.slides.length&&(deck.slides.splice(currentIndex,1),currentIndex=Math.max(0,currentIndex-1),pushHistory(),renderAll(),postSave())}),document.getElementById("undoBtn").addEventListener("click",undo),document.getElementById("redoBtn").addEventListener("click",redo),window.addEventListener("keydown",e=>{let t=e.ctrlKey||e.metaKey,n=(e.key||"").toLowerCase();if(t&&"z"===n){e.preventDefault(),e.shiftKey?redo():undo();return}if(t&&"y"===n){e.preventDefault(),redo();return}if(t&&"c"===n&&selection.length){if(activelySelectingText())return;e.preventDefault(),copySelected();return}if(t&&"x"===n&&selection.length){if(activelySelectingText())return;e.preventDefault(),cutSelected();return}if(t&&"v"===n){if(activelySelectingText())return;e.preventDefault(),pasteFromClipboard();return}if(("delete"===n||"backspace"===n)&&selection.length){let i=currentSlide();i.objects=i.objects.filter(e=>!selection.includes(e.id)),selection=[],renderCanvas(),pushHistory(),postSave();return}if(["arrowup","arrowdown","arrowleft","arrowright"].includes(n)&&selection.length){let l=currentSlide(),s=e.shiftKey?10:1;selection.forEach(e=>{let t=l.objects.find(t=>t.id===e);t&&("arrowup"===n&&(t.y-=s),"arrowdown"===n&&(t.y+=s),"arrowleft"===n&&(t.x-=s),"arrowright"===n&&(t.x+=s))}),renderCanvas(),pushHistory(),postSave()}}),window.addEventListener("paste",e=>{if(activelySelectingText())return;let t=e.clipboardData?.getData("text/plain");if(t)try{let n=JSON.parse(t);n?.type==="realtime-slides"&&Array.isArray(n.objects)&&(e.preventDefault(),pasteObjectsAt(n.objects,lastMouse.x,lastMouse.y))}catch(i){}}),stage.addEventListener("paste",e=>{let t=(e.clipboardData||window.clipboardData)?.items||[];for(let n of t)if(n.type&&0===n.type.indexOf("image")){let i=n.getAsFile();i&&(e.preventDefault(),handleImageFile(i,lastMouse.x,lastMouse.y))}}),stage.addEventListener("dragover",e=>{e.preventDefault()}),stage.addEventListener("drop",e=>{e.preventDefault();let t=stage.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top,l=e.dataTransfer.files||[];for(let s of l)s.type&&s.type.startsWith("image/")&&handleImageFile(s,n,i)});const presentBtn=document.getElementById("presentBtn");function updatePresentScale(){if(!isPresenting)return;let e=window.innerWidth,t=window.innerHeight;stage.style.transform=`translate(-50%,-50%)scale(${Math.min(e/960,t/540)})`}function renderPresentation(){if(!isPresenting)return;ensureSlide();let e=currentSlide();stage.style.background=e.background||"#ffffff",stage.innerHTML="",e.objects.forEach(e=>{let t=document.createElement("div");if(t.style.position="absolute",t.style.left=e.x+"px",t.style.top=e.y+"px",t.style.width=e.width+"px",t.style.height=e.height+"px",t.style.transform=`rotate(${e.rotation||0}deg)`,"rect"===e.type)t.style.background=e.fill||"#ddd";else if("ellipse"===e.type)t.style.background=e.fill||"#ddd",t.style.borderRadius="999px";else if("text"===e.type)t.style.color=e.color||"#111111",t.style.fontSize=(e.fontSize||24)+"px",t.style.fontFamily=e.fontFamily||"system-ui, Segoe UI, Roboto, sans-serif",t.style.whiteSpace="pre-wrap",applyTextAlignStyles(t,e.align),t.innerHTML=e.html??(e.text||"");else if("image"===e.type){let n=new Image;n.src=e.dataUrl,n.style.width="100%",n.style.height="100%",n.style.objectFit="contain",t.appendChild(n)}stage.appendChild(t)}),updatePresentScale()}function setTextAlign(e){let t=currentSlide(),n=!1;selection.forEach(i=>{let l=t.objects.find(e=>e.id===i);l&&"text"===l.type&&(l.align=e,n=!0)}),n&&(renderCanvas(),pushHistory(),postSave())}presentBtn.addEventListener("click",()=>{document.fullscreenElement||(stage.classList.add("presenting"),stage.requestFullscreen().then(()=>{isPresenting=!0,renderPresentation(),updatePresentScale()}).catch(console.error))}),document.addEventListener("fullscreenchange",()=>{document.fullscreenElement?window.addEventListener("resize",updatePresentScale):(isPresenting=!1,stage.classList.remove("presenting"),stage.style.transform="",window.removeEventListener("resize",updatePresentScale),renderAll())}),window.addEventListener("keydown",e=>{isPresenting&&("ArrowRight"===e.key?(currentIndex=Math.min(deck.slides.length-1,currentIndex+1),renderPresentation()):"ArrowLeft"===e.key?(currentIndex=Math.max(0,currentIndex-1),renderPresentation()):"Escape"===e.key&&document.fullscreenElement&&document.exitFullscreen())});const alignLeftBtn=$("#alignLeft"),alignCenterBtn=$("#alignCenter"),alignRightBtn=$("#alignRight");function applyTextAlignStyles(e,t){let n=t||"center";e.style.textAlign=n,e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="left"===n?"flex-start":"right"===n?"flex-end":"center",e.style.padding="4px"}alignLeftBtn.onclick=()=>setTextAlign("left"),alignCenterBtn.onclick=()=>setTextAlign("center"),alignRightBtn.onclick=()=>setTextAlign("right");const hamburger=document.getElementById("hamburger");function execOnFocused(e){let t=document.activeElement;t&&t.isContentEditable&&document.execCommand(e,!1,null)}hamburger.addEventListener("click",()=>{document.querySelector(".app").classList.toggle("collapsed"),document.querySelector(".side").classList.toggle("collapsed")}),document.getElementById("boldBtn").addEventListener("click",()=>execOnFocused("bold")),document.getElementById("italicBtn").addEventListener("click",()=>execOnFocused("italic")),document.getElementById("underlineBtn").addEventListener("click",()=>execOnFocused("underline")),renderAll();